<!-- Audio Player Widget — Bloc HTML PageBuilder -->
<div id="audio-widget">
  <div class="audio-trigger">
    <svg class="icon headphone-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
      <path d="M12 2a10 10 0 00-10 10v7a3 3 0 003 3h2a2 2 0 002-2v-6a2 2 0 00-2-2H5v-2a7 7 0 0114 0v2h-2a2 2 0 00-2 2v6a2 2 0 002 2h2a3 3 0 003-3v-7A10 10 0 0012 2z"/>
    </svg>
    <span class="audio-duration">0:00</span>
    <span class="audio-text">Écouter la version audio</span>
  </div>
  <div class="audio-player" style="display: none;">
    <button class="play-pause" aria-label="Play/Pause">▶</button>
    <span class="elapsed">0:00</span>
    <input type="range" class="seek" min="0" max="100" value="0" step="0.1">
    <span class="remaining">-0:00</span>
  </div>
  <audio id="audio-element" preload="metadata"></audio>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;700&display=swap');

  /* Conteneur fixe pour éviter tout saut */
  #audio-widget {
    font-family: 'Red Hat Display', sans-serif;
    position: relative;
    height: 28px;            /* ajuste selon la hauteur de vos icônes/textes */
    line-height: 28px;
  }

  /* Texte et icônes en noir, monospace pour les chiffres */
  #audio-widget .audio-trigger,
  #audio-widget .audio-player {
    color: #000;
    position: absolute;
    top: 0;
    left: 0;
  }
  .audio-trigger {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
  }
  .audio-trigger.error { cursor: default; }

  .audio-trigger .icon {
    width: 24px;
    height: 24px;
    fill: currentColor;
    margin-right: 8px;
  }

  /* Largeur fixe pour éviter le glissement horizontal */
  .audio-duration,
  .elapsed,
  .remaining {
    display: inline-block;
    width: 4ch;             /* 4 caractères : mm:ss ou -mm:ss */
    text-align: right;
    font-family: monospace;
    font-size: 14px;
    margin-right: 8px;
  }

  .audio-text {
    font-size: 16px;
  }

  .audio-player {
    display: inline-flex;
    align-items: center;
    /* plus de margin-top : on superpose exactement sur le trigger */
  }
  .audio-player .play-pause {
    border: none;
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    margin-right: 8px;
  }
  .audio-player .seek {
    flex: 1;
    cursor: pointer;
    accent-color: #000;
  }

  /* Style message d’erreur si pas de fichier audio */
  .audio-trigger.error {
    color: #D51D2C !important;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var storyId = (window.Fusion?.globalContent?._id) || 'MVFJNNANPFBOJBWA6Y22RST7W4';
    console.log('▶ storyId utilisé :', storyId);
    if (!storyId) return;

    var audioUrl = 'https://versions-audio-ue1.s3.us-east-1.amazonaws.com/audio/' + storyId + '.mp3';
    var widget    = document.getElementById('audio-widget');
    var trigger   = widget.querySelector('.audio-trigger');
    var player    = widget.querySelector('.audio-player');
    var audioEl   = widget.querySelector('#audio-element');
    var durationL = trigger.querySelector('.audio-duration');
    var playBtn   = player.querySelector('.play-pause');
    var elapsedL  = player.querySelector('.elapsed');
    var remainingL= player.querySelector('.remaining');
    var seekBar   = player.querySelector('.seek');

    // Erreur si pas de mp3
    audioEl.addEventListener('error', function() {
      durationL.style.display = 'none';
      trigger.classList.add('error');
      trigger.querySelector('.audio-text').textContent =
        "La version audio n'est pas disponible";
      trigger.style.pointerEvents = 'none';
    });

    // Chargement des métadonnées
    audioEl.src = audioUrl;
    audioEl.addEventListener('loadedmetadata', function() {
      var d = Math.round(audioEl.duration);
      durationL.textContent   = formatTime(d);
      remainingL.textContent  = '-' + formatTime(d);
      seekBar.max             = d;
    });

    // Mise à jour pendant la lecture
    audioEl.addEventListener('timeupdate', function() {
      var t = Math.floor(audioEl.currentTime);
      elapsedL.textContent    = formatTime(t);
      remainingL.textContent  = '-' + formatTime(Math.round(audioEl.duration - t));
      seekBar.value           = t;
    });

    // Seek
    seekBar.addEventListener('input', function() {
      audioEl.currentTime = this.value;
    });

    // Play/Pause
    playBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (audioEl.paused) {
        audioEl.play();
        playBtn.textContent = '❚❚';
      } else {
        audioEl.pause();
        playBtn.textContent = '▶';
      }
    });

    // Clic pour déployer/le lancer
    trigger.addEventListener('click', function() {
      trigger.style.display = 'none';
      player.style.display  = 'inline-flex';
      audioEl.play();
      playBtn.textContent = '❚❚';
    });

    function formatTime(sec) {
      var m = Math.floor(sec/60), s = sec % 60;
      return m + ':' + (s < 10 ? '0'+s : s);
    }
  });
</script>
